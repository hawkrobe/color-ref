<!DOCTYPE html>
<html>
    <head>
        <title>Word-color association task</title>
        <script src="jspsych-6.1.0/jspsych.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-color-picker.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-survey-html-form.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
        <script src="munsell.js"></script>
        <script src="target-words.js"></script>
        <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <style>
        button {
          border: none;
          padding: 32px 32px;
          display: inline-block;
          font-size: 16px;
          transition-duration: 0.6s;
        }
        span {
          color: red;
        }
        </style>
    </head>
    <body>
    </body>
    <script>

    //==========================================================================
    // START EXPERIMENT
    //==========================================================================

    // for(let i=0; i < munsell.length; i++){
    //   console.log(munsell[i].rgb);
    // };

    var timeline = [];


    var welcome = {
        type: 'html-keyboard-response',
        stimulus: 'Welcome to the experiment. <strong>Press any key to begin</strong>'
    };

    timeline.push(welcome);

    //==========================================================================
    // COLORBLINDESS TRIALS
    //==========================================================================

    /* define instructions trial */
    var instructions = {
      type: "html-keyboard-response",
      stimulus: "<p>To begin with, you will be shown a series of images intended to test your color vision.</p>" +
      "<p>For each image, press the key of the number you see in the image. <br>If you are unsure or do not see anything, press the enter key.</p>" +
      "<p>Please ensure that you are taking this experiment on a desktop or laptop computer <br>" +
      "and that your screen is set to its default brightness and color temperature (e.g. turn off flux).</p>" +
      "<p><strong>Press any key to begin.</strong></p>"
    };

    timeline.push(instructions);

    // all single-digit vanishing plates from ishihara colorblindness test
    var ishiharaPlates = ['Plate2.gif', 'Plate4.gif', 'Plate5.gif'];

    for(let i=0; i < ishiharaPlates.length;i++){
      let str = './ishihara-vanishing-plates/' + ishiharaPlates[i];

      var colorblindness_trial = {
        type: 'image-keyboard-response',
        stimulus: str,
        choices: [13, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57],
        prompt: "<p>Press the key of the number you see. If you are unsure or do not see anything, press the enter key.</p>"
      };
      timeline.push(colorblindness_trial);
    }


    //==========================================================================
    // NORMING TASK
    //==========================================================================

    /* define instructions trial for target words */
    var instructions = {
      type: "html-keyboard-response",
      stimulus: "<p>In this experiment, you will be given a word " +
          "and a Munsell color space.</p><p>Select the color in the color space that " +
          "you most closely associate with this word.</p>" +
          "<p>Please ensure that you are taking this experiment on a desktop or laptop computer <br>" +
          "and that your screen is set to its default brightness and color temperature (e.g. turn off flux).</p>" +
          "<p><strong>Press any key to begin.</strong></p>"
    };

    timeline.push(instructions);

    //--------------------------------------------------------------------------
    // PRACTICE WORD TRIALS
    //--------------------------------------------------------------------------

    var instructions = {
      type: "html-keyboard-response",
      stimulus: "<p>The next few practice trials will allow you to get comfortable with the system before the experiment begins.</p>" +
          "<p><strong>Press any key to begin the practice trials.</strong></p>"
    };

    timeline.push(instructions);

    // practice words (i.e. color words)
    var practice = ['red', 'orange', 'yellow', 'green', 'blue', 'purple', 'pink'];

    for(let i=0; i < practice.length;i++){
      var trial = {
        type: 'color-picker',
        stimulus: '<p>' + practice[i] + '</p>',
        colors: munsell,
        margin_horizontal: '0px',
        margin_vertical: '-4px',
        height: '70px',
        width: '70px',
        prompt: '<p><font size="3">Select the color you most closely associate with the word.</font></p>',
        post_trial_gap: 500
      };
      console.log(trial)
      timeline.push(trial);
    }

    var instructions = {
      type: "html-keyboard-response",
      stimulus: "<p>You have completed the practice trials.</p>" +
          "<p><strong>Press any key to begin the experiment.</strong></p>"
    };

    timeline.push(instructions);

    //--------------------------------------------------------------------------
    // TARGET WORDS PART I: PARTICIPANT PROVIDES INDIVIDUAL JUDGEMENTS
    // NEED TO CHANGE WORD SET FOR EACH NEW EXPERIMENT
    //--------------------------------------------------------------------------

    // randomize array of target words
    var shuffledTargets = jsPsych.randomization.repeat(wordSet2, 1);
    console.log(shuffledTargets)

    // TARGET WORD TRIALS
    for(let i=0; i < shuffledTargets.length;i++){
      var trial = {
        type: 'color-picker',
        stimulus: '<p>' + shuffledTargets[i].word + '</p>',
        colors: munsell,
        margin_horizontal: '0px',
        margin_vertical: '-4px',
        height: '70px',
        width: '70px',
        prompt: '<p><font size="3">Select the color you most closely associate with the word.</font></p>',
        post_trial_gap: 500
      };
      timeline.push(trial);
    }

    //--------------------------------------------------------------------------
    // TARGET WORDS PART II: Make new judgement for same words and rate expected agreement
    // NEED TO CHANGE WORD SET FOR EACH NEW EXPERIMENT
    //--------------------------------------------------------------------------

    var instructions = {
      type: "html-keyboard-response",
      stimulus: "<p>Like before, the next few trials will ask you to select the color in the color space that " +
      "you most closely associate with the given word.</p>" +
      "<p>You will also be asked to indicate how strongly you believe <strong>others</strong> will share your color association for the word.</p>" +
      "<p><strong>Press any key to continue.</strong></p>"
    };

    timeline.push(instructions);

    // randomize array of target words
    var shuffledTargets = jsPsych.randomization.repeat(wordSet2, 1);
    console.log(shuffledTargets)

    // TARGET WORD TRIALS
    for(let i=0; i < shuffledTargets.length;i++){
      var trial = {
        timeline: [
          {
            type: 'color-picker',
            stimulus: '<p>' + shuffledTargets[i].word + '</p>',
            colors: munsell,
            margin_horizontal: '0px',
            margin_vertical: '-4px',
            height: '70px',
            width: '70px',
            prompt: '<p><font size="3">Select the color you most closely associate with the word.</font></p>',
            post_trial_gap: 500
          }, {
            type: 'html-slider-response',
            stimulus: function() {
              var lastTrialColor = jsPsych.data.get().last(1).values()[0].button_pressed;
              var color = munsell[lastTrialColor].rgb
              console.log(color)
              return '<div style="height: 100px;width:100%;display: table;background-color: rgb' + color + ';"><h2 style="color: transparent;background: inherit;-webkit-background-clip: text;height: 100%;filter: invert(1) grayscale(1) contrast(100);">'+ shuffledTargets[i].word +'</h2></div>'
            },
            labels: ['<p style="color:black"><strong>weakly</strong><br>(most people will <br>have a different color <br>association than I do)</p>',
                     '<font style="color:black"><strong>neutral</strong><br> (roughly the same number <br>of people will have the <br>same or different color <br>associations as I do)</font>',
                     '<font style="color:black"><strong>strongly</strong><br>(most people will <br>have the same color <br>association as I do)</font>'],
            prompt: '<br> <br><p>How strongly do you expect <strong>others</strong> to share your color association for this word?</p>',
            buttom_label: 'Next',
            min: 1,
            max: 5,
            start: 3,
            require_movements: true
          }
        ]
      };
      timeline.push(trial);
    };


    //==========================================================================
    // EXIT SURVEY
    //==========================================================================


    // ENDING SURVEY TRIAL
    var survey = {
      type: 'survey-html-form',
      preamble: '<p><b>Please complete the following required questions:</b> </p>',
      html: '<p><div>With which gender do you most identify?</div>'+
      '<div><input type="radio" id="genderChoice1" name="gender" value="male" required><label for="genderChoice1">Male</label></div>'+
      '<div><input type="radio" id="genderChoice2" name="gender" value="female"><label for="genderChoice2">Female</label></div>' +
      '<div><input type="radio" id="genderChoice3" name="gender" value="nonconforming"><label for="genderChoice3">Gender Variant/Non-Conforming</label></div>' +
      '<div><input type="radio" id="genderChoice4" name="gender" value="abstain"><label for="genderChoice4">Prefer not to answer</label></div></p>' +
      '<p><div><label for="age">Enter your age:</label></div><div><input type="text" id="age" name="age" required></div></p>' +
      '<p><div> Did you understand the instructions?</div>'+
      '<div><input type="radio" id="understoodChoice1" name="understood" value="yes" required><label for="understoodChoice1">Yes</label></div>'+
      '<div><input type="radio" id="understoodChoice2" name="understood" value="no"><label for="understoodChoice2">No</label></div></p>' +
      '<p><div><label for="language">What languages are you proficient in?</label></div><div><input type="text" id="language" name="language" required></div></p>' +
      '<p><div> Were there any words that you did not know?</div>'+
      '<div><input type="radio" id="wordsChoice1" name="words" value="yes" required><label for="wordsChoice1">Yes</label></div>'+
      '<div><input type="radio" id="wordsChoice2" name="words" value="no"><label for="wordsChoice2">No</label></div>' +
      '<div><label for="wordsText">If yes, enter them here:</label></div><div><input type="text" id="wordsText" name="wordsText"></div></p>' +
      '<p><div><label for="comments">Comments or suggestions?</label></div><div><input type="text" id="comments" name="comments"></div></p>'
    };

    timeline.push(survey);

    var endScreen = {
      type: 'html-button-response',
      stimulus: '<p>You have completed the experiment. Thank you for your participation.</p>' +
      '<p><strong>Click the button to submit the HIT.</strong></p>',
      choices: ['Submit HIT']
    };

    timeline.push(endScreen);

    //==========================================================================
    /* start the experiment */
    jsPsych.init({
      timeline: timeline,
      /* execute displayData function when the experiment ends by using the
      on_finish callback function. this function will automatically execute once
      all the trials in the experiement are finished */
      on_finish: function() {
        jsPsych.data.displayData();
      }
    })

    </script>

</html>
